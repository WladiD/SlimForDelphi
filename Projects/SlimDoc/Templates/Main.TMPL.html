<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Slim Fixture Documentation</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
      padding-bottom: 110px;
    }

    h1 {
      color: #333;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
      margin-top: 0;
    }

    h2 {
      color: #0078d7;
      margin-top: 30px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      color: #333;
    }

    tr:nth-child(even) {
      background-color: #fcfcfc;
    }

    .fixture {
      background-color: white;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .fixture-header {
      background-color: #e6f2ff;
      padding: 10px;
      font-weight: bold;
      font-size: 1.4em;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 5px solid #0078d7;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .fixture-info {
      width: auto;
      border: none;
      margin-bottom: 15px;
      background-color: transparent;
      box-shadow: none;
    }

    .fixture-info td {
      border: none;
      padding: 2px 0;
    }

    .fixture-info td:first-child {
      padding-right: 10px;
      font-weight: bold;
    }

    .fixture-ns {
      color: #888;
    }

    .muted {
      color: #888;
    }

    .col-toggle {
      width: 20px;
    }

    .namespace {
      color: #555;
      font-weight: normal;
      margin-left: 10px;
    }

    .class-name {
      font-family: Consolas, monospace;
      color: #d63384;
    }

    .toc {
      background-color: white;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 30px;
    }

    /* Search Bar Styles */
    .search-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
      padding: 10px 20px;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .search-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    #searchInput {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
    }

    #searchInput:focus {
      border-color: #0078d7;
    }

    .search-label {
      margin-right: 15px;
      font-weight: bold;
      color: #555;
    }

    .filter-options {
      display: flex;
      font-size: 0.9em;
      color: #555;
      gap: 15px;
    }

    .filter-options label {
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .filter-options input {
      margin-right: 5px;
    }

    .options-toggle {
      margin-left: 10px;
      color: #555;
      font-size: 0.9em;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
    }

    .options-toggle input {
      margin-right: 5px;
    }

    .hidden-by-search {
      display: none !important;
    }

    /* Styles for inherited members */
    .inherited-member {
      display: none;
      color: #777;
      font-style: italic;
      background-color: #f8f8f8 !important;
    }

    .inherited-toggle {
      font-size: 0.6em;
      font-weight: normal;
      margin-left: 20px;
      cursor: pointer;
      user-select: none;
    }

    .unsynchronized-member {
      color: #888;
    }

    /* Usage Row Styles */
    .usage-row {
      background-color: #f0f0f0;
    }

    .usage-content {
      padding: 5px 10px 5px 30px;
      font-size: 0.9em;
      color: #444;
    }

    .description-content + .usage-content {
      margin-top: 20px;
    }

    .usage-content strong {
      color: #222;
    }

    .toggle-btn {
      cursor: pointer;
      color: #0078d7;
      font-weight: bold;
      user-select: none;
      display: inline-block;
      width: 16px;
      text-align: center;
    }

    .usage-links a {
      display: inline-block;
      margin-right: 5px;
      margin-bottom: 3px;
      padding: 1px 5px;
      background-color: #fff;
      border-radius: 3px;
      font-size: 0.9em;
      color: #333;
      text-decoration: none;
      border: 1px solid #ccc;
    }

    .usage-links a:hover {
      background-color: #e6f2ff;
      border-color: #0078d7;
    }

    /* Description Styles */
    .description-content {
      color: #555;
    }

    .fixture-description {
      padding: 10px;
      margin-bottom: 20px;
      background-color: #f9f9f9;
      border-left: 4px solid #ddd;
    }

    .member-description {
      padding: 5px 10px 5px 30px;
    }

    /* XML Doc Styles */
    .xml-summary {
      margin-bottom: 8px;
      display: block;
      white-space: pre-wrap;
    }

    .xml-param {
      margin-left: 10px;
      display: block;
    }

    .xml-param-name {
      font-weight: bold;
      font-family: Consolas, monospace;
      color: #333;
    }

    .xml-returns {
      margin-top: 8px;
      font-weight: bold;
      color: #0078d7;
      display: block;
    }

    .highlight {
      background-color: #fff2a8;
      color: black;
      border-radius: 2px;
    }

    .fixture-name-clickable {
      cursor: pointer;
    }

    .fixture-name-clickable:hover {
      text-decoration: underline;
    }

    .filter-icon {
      display: none;
      margin-left: 8px;
      font-size: 0.9em;
      color: #0078d7;
      text-decoration: none !important;
      display: inline-block;
      transition: transform 0.2s ease-in-out;
    }

    .fixture-name-clickable:hover .filter-icon {
      transform: scale(1.3);
      color: #005a9e;
    }
  </style>
  <script>
    function removeHighlights() {
      var highlights = document.querySelectorAll(".highlight");
      for (var i = 0; i < highlights.length; i++) {
        var span = highlights[i];
        var parent = span.parentNode;
        parent.replaceChild(document.createTextNode(span.textContent), span);
        parent.normalize();
      }
    }

    function highlight(element, text) {
      if (!text || !element) return;
      text = text.toUpperCase();

      var node = element.firstChild;
      while (node) {
        var next = node.nextSibling;
        if (node.nodeType === 3) { // Text Node
          var val = node.nodeValue;
          var idx = val.toUpperCase().indexOf(text);
          if (idx >= 0) {
            var span = document.createElement("span");
            span.className = "highlight";
            span.textContent = val.substr(idx, text.length);

            var after = node.splitText(idx);
            var remaining = after.splitText(text.length);

            after.parentNode.replaceChild(span, after);
            node = remaining; // Continue searching in the remaining text
            continue;
          }
        } else if (node.nodeType === 1 && node.className !== "highlight" && node.tagName !== "SCRIPT") {
          highlight(node, text);
        }
        node = next;
      }
    }

    function setSearch(text) {
      var input = document.getElementById("searchInput");
      if (input.value === text) {
        input.value = "";
      } else {
        input.value = text;
      }
      filterFixtures();
    }

    function toggleInherited(checkbox, fixtureId) {
      var container = document.getElementById(fixtureId);
      var rows = container.querySelectorAll(".inherited-member");
      for (var i = 0; i < rows.length; i++) {
        if (rows[i].classList.contains("usage-row")) {
          rows[i].style.display = "none";
        } else {
          rows[i].style.display = checkbox.checked ? "table-row" : "none";
        }
      }
    }

    function toggleUsage(btn, rowId) {
      var row = document.getElementById(rowId);
      if (!row) return;
      if (row.style.display === "none") {
        row.style.display = "table-row";
        btn.innerHTML = "&#9660;";
      } else {
        row.style.display = "none";
        btn.innerHTML = "&#9658;";
      }
    }

    function updateSearchOption() {
      var useFixture = document.getElementById("chkFixture").checked;
      var useNamespace = document.getElementById("chkNamespace").checked;
      var useMember = document.getElementById("chkMember").checked;
      var useComment = document.getElementById("chkComment").checked;
      var useUsage = document.getElementById("chkUsage").checked;

      var parts = [];
      if (useFixture) parts.push("fixtures");
      if (useNamespace) parts.push("namespaces");
      if (useMember) parts.push("methods/properties");
      if (useComment) parts.push("comments");
      if (useUsage) parts.push("usage");

      var text = "Search";
      if (parts.length > 0) {
        text += " for " + parts.join(", ");
      }
      text += "...";

      document.getElementById("searchInput").placeholder = text;
      filterFixtures();
    }

    function filterFixtures() {
      removeHighlights();

      var input = document.getElementById("searchInput");
      var filter = input.value.toUpperCase();
      var cleanFilter = filter.replace(/\s+/g, "");
      var useClean = (cleanFilter.length > 0 && cleanFilter !== filter);

      var useFixture = document.getElementById("chkFixture").checked;
      var useNamespace = document.getElementById("chkNamespace").checked;
      var useMember = document.getElementById("chkMember").checked;
      var useComment = document.getElementById("chkComment").checked;
      var useUsage = document.getElementById("chkUsage").checked;

      var fixtures = document.getElementsByClassName("fixture");
      var tocLinks = document.querySelectorAll(".toc li");

      for (var i = 0; i < fixtures.length; i++) {
        var fixture = fixtures[i];
        var header = fixture.querySelector(".fixture-header");
        var inheritedCheckbox = header.querySelector(".inherited-toggle input");

        // Update filter icon visibility
        var icon = fixture.querySelector(".filter-icon");
        if (icon) {
          icon.style.display = (filter.length > 0) ? "inline-block" : "none";
        }

        // Fixture & Namespace
        var headerText = "";
        var nameSpan = header.querySelector(".fixture-name-clickable");
        if (useFixture) {
           if (nameSpan)
             headerText += (nameSpan.textContent || ""); // Correctly get full text
           else
             headerText += (header.querySelector("span:first-child").firstChild.textContent || ""); 
        }
        if (useNamespace) headerText += (header.querySelector(".namespace").textContent || "");

        // Also check class name if useFixture
        if (useFixture) {
          var classElem = fixture.querySelector(".class-name");
          if (classElem) headerText += classElem.textContent;
        }
        // Also check class comment if useComment
        if (useComment) {
          var directDesc = fixture.querySelectorAll(":scope > .description-content");
          for (var d = 0; d < directDesc.length; d++) {
            headerText += directDesc[d].textContent;
          }
        }

        var headerMatches = headerText.toUpperCase().indexOf(filter) > -1;
        if (!headerMatches && useClean) {
          headerMatches = headerText.toUpperCase().indexOf(cleanFilter) > -1;
        }

        var rows = fixture.querySelectorAll("tbody tr");
        var hasVisibleRow = false;
        var hasLocalMatch = headerMatches;
        var hasInheritedMatch = false;

        for (var j = 0; j < rows.length; j++) {
          var row = rows[j];
          if (row.classList.contains("usage-row")) continue;

          var usageRow = row.nextElementSibling;
          var hasUsageRow = usageRow && usageRow.classList.contains("usage-row");

          if (filter === "") {
            row.classList.remove("hidden-by-search");
            if (hasUsageRow) {
              usageRow.classList.remove("hidden-by-search");
              usageRow.style.display = "none";
              var btn = row.querySelector(".toggle-btn");
              if (btn) btn.innerHTML = "&#9658;";
            }
            hasVisibleRow = true;
            continue;
          }

          var rowMatches = false;
          var usageMatches = false;
          var memberNameMatches = false;

          // Member Name & Full Row
          if (useMember) {
            var rowText = row.textContent || row.innerText;
            if (rowText.toUpperCase().indexOf(filter) > -1 || (useClean && rowText.toUpperCase().indexOf(cleanFilter) > -1)) {
              rowMatches = true;
              // Check if name specifically matches (usually 2nd cell)
              var nameCell = row.cells[1];
              if (nameCell) {
                var nameText = nameCell.textContent.toUpperCase();
                if (nameText.indexOf(filter) > -1 || (useClean && nameText.indexOf(cleanFilter) > -1)) {
                  memberNameMatches = true;
                }
              }
            }
          }

          // Comment & Usage
          if (hasUsageRow) {
            // Description
            if (useComment) {
              var descDiv = usageRow.querySelector(".description-content");
              if (descDiv) {
                var descText = descDiv.textContent.toUpperCase();
                if (descText.indexOf(filter) > -1 || (useClean && descText.indexOf(cleanFilter) > -1)) usageMatches = true;
              }
            }
            // Usage
            if (useUsage) {
              var usageDiv = usageRow.querySelector(".usage-content");
              if (usageDiv) {
                var usageText = usageDiv.textContent.toUpperCase();
                if (usageText.indexOf(filter) > -1 || (useClean && usageText.indexOf(cleanFilter) > -1)) usageMatches = true;
              }
            }
          }

          if (headerMatches || rowMatches || usageMatches) {
            row.classList.remove("hidden-by-search");
            hasVisibleRow = true;

            // Track match types
            if (row.classList.contains("inherited-member")) {
              if (memberNameMatches || usageMatches) hasInheritedMatch = true;
            } else {
              if (rowMatches || usageMatches) hasLocalMatch = true;
            }

            if (rowMatches && filter.length > 0) {
              highlight(row, filter);
              if (useClean) highlight(row, cleanFilter);
            }

            if (hasUsageRow) {
              usageRow.classList.remove("hidden-by-search");

              if (usageMatches) {
                usageRow.style.display = "table-row";
                if (filter.length > 0) {
                  highlight(usageRow, filter);
                  if (useClean) highlight(usageRow, cleanFilter);
                }
                var btn = row.querySelector(".toggle-btn");
                if (btn) btn.innerHTML = "&#9660;";
              } else {
                usageRow.style.display = "none";
                var btn = row.querySelector(".toggle-btn");
                if (btn) btn.innerHTML = "&#9658;";
              }
            }
          } else {
            row.classList.add("hidden-by-search");
            if (hasUsageRow) {
              usageRow.classList.add("hidden-by-search");
              usageRow.style.display = "none";
            }
          }
        }

        // Auto-toggle inherited members if there are NO local matches but inherited matches, OR if the fixture header matches
        if (inheritedCheckbox) {
          var shouldBeChecked = (filter === "") ? false : ((hasInheritedMatch && !hasLocalMatch) || headerMatches);
          if (inheritedCheckbox.checked !== shouldBeChecked) {
            inheritedCheckbox.checked = shouldBeChecked;
            toggleInherited(inheritedCheckbox, fixture.id);
          }
        }

        if (headerMatches && filter.length > 0) {
          var clickableName = header.querySelector(".fixture-name-clickable");
          if (clickableName) {
            highlight(clickableName, filter);
            if (useClean) highlight(clickableName, cleanFilter);
          } else {
            highlight(header, filter);
            if (useClean) highlight(header, cleanFilter);
          }

          var classElem = fixture.querySelector(".class-name");
          if (classElem) {
            highlight(classElem, filter);
            if (useClean) highlight(classElem, cleanFilter);
          }
          var directDesc = fixture.querySelectorAll(":scope > .description-content");
          for (var d = 0; d < directDesc.length; d++) {
            highlight(directDesc[d], filter);
            if (useClean) highlight(directDesc[d], cleanFilter);
          }
        }

        // Hide/Show sections based on visible rows
        var sections = ['Constructors', 'Methods', 'Properties'];
        for (var s = 0; s < sections.length; s++) {
          var sectionName = sections[s];
          var h3s = fixture.querySelectorAll('h3');
          for (var h = 0; h < h3s.length; h++) {
            if (h3s[h].textContent === sectionName) {
              var table = h3s[h].nextElementSibling;
              if (table && table.tagName === 'TABLE') {
                 var visibleRows = 0;
                 var bodyRows = table.querySelectorAll('tbody tr');
                 for (var r = 0; r < bodyRows.length; r++) {
                   if (!bodyRows[r].classList.contains('hidden-by-search') && 
                       !bodyRows[r].classList.contains('usage-row') &&
                       bodyRows[r].style.display !== 'none') {
                     visibleRows++;
                   }
                 }

                 if (visibleRows > 0) {
                   h3s[h].style.display = '';
                   table.style.display = '';
                 } else {
                   h3s[h].style.display = 'none';
                   table.style.display = 'none';
                 }
              }
            }
          }
        }

        if (hasVisibleRow || headerMatches) {
          fixture.style.display = "";
        } else {
          fixture.style.display = "none";
        }
      }

      for (var k = 0; k < tocLinks.length; k++) {
        var link = tocLinks[k];
        var linkText = link.textContent.toUpperCase();
        if (linkText.indexOf(filter) > -1 || (useClean && linkText.indexOf(cleanFilter) > -1)) {
          link.style.display = "";
          if (filter.length > 0) {
            highlight(link, filter);
            if (useClean) highlight(link, cleanFilter);
          }
        } else {
          link.style.display = "none";
        }
      }
    }
    function toggleSearchOptions(checkbox) {
      var options = document.getElementById("filterOptions");
      if (checkbox.checked) {
        options.style.display = "flex";
      } else {
        options.style.display = "none";
      }
    }
    window.onload = updateSearchOption;
  </script>
</head>
<body>
  <h1>Registered Slim Fixtures</h1>

  <div class="toc">
    <h2>Table of Contents</h2>
    <ul>
      {{#Fixtures}}
      <li><a href="#{{Id}}">{{Name}}</a> <span class="fixture-ns">({{Namespace}})</span></li>
      {{/Fixtures}}
    </ul>
  </div>

  {{#Fixtures}}
  <div class="fixture" id="{{Id}}">
    <div class="fixture-header">
      <span class="fixture-name-clickable" onclick="setSearch('{{Name}}')" title="Filter by this fixture"><span class="namespace">{{Namespace}}.</span>{{Name}} <span class="filter-icon">&#128269;</span></span> 
      {{#HasInherited}}
      <label class="inherited-toggle">
        <input type="checkbox" onclick="toggleInherited(this, '{{Id}}')"> Show inherited members
      </label>
      {{/HasInherited}}
    </div>

    <table class="fixture-info">
      <tr>
        <td>Unit:</td>
        <td>{{UnitName}}</td>
      </tr>
      <tr>
        <td>Delphi Class:</td>
        <td><span class="class-name">{{{DelphiClass}}}</span></td>
      </tr>
    </table>

    {{#DescriptionHtml}}
    <div class="description-content fixture-description">{{{DescriptionHtml}}}</div>
    {{/DescriptionHtml}}

    {{#HasConstructors}}
    <h3>Constructors</h3>
    <table>
      <thead>
        <tr>
          <th class="col-toggle"></th>
          <th>Name</th>
          <th>Parameters</th>
          <th>Origin</th>
        </tr>
      </thead>
      <tbody>
        {{#Constructors}}
        <tr{{#RowClass}} class="{{RowClass}}"{{/RowClass}}>
          <td>
            {{#HasUsageOrDesc}}
            <span class="toggle-btn" onclick="toggleUsage(this, '{{UsageRowId}}')">&#9658;</span>
            {{/HasUsageOrDesc}}
          </td>
          <td>{{Name}}</td>
          <td>{{ParamsString}}</td>
          <td class="muted">{{Origin}}</td>
        </tr>
        {{#HasUsageOrDesc}}
        <tr class="{{UsageRowClass}}" id="{{UsageRowId}}" style="display:none;">
          <td colspan="4">
            {{#DescriptionHtml}}
            <div class="description-content member-description">{{{DescriptionHtml}}}</div>
            {{/DescriptionHtml}}
          </td>
        </tr>
        {{/HasUsageOrDesc}}
        {{/Constructors}}
      </tbody>
    </table>
    {{/HasConstructors}}

    <h3>Methods</h3>
    <table>
      <thead>
        <tr>
          <th class="col-toggle"></th>
          <th>Name</th>
          <th>Parameters</th>
          <th>Return Type</th>
          <th>Sync Mode</th>
          <th>Origin</th>
        </tr>
      </thead>
      <tbody>
        {{#Methods}}
        <tr{{#RowClass}} class="{{RowClass}}"{{/RowClass}}>
          <td>
            {{#HasUsageOrDesc}}
            <span class="toggle-btn" onclick="toggleUsage(this, '{{UsageRowId}}')">&#9658;</span>
            {{/HasUsageOrDesc}}
          </td>
          <td>{{Name}}</td>
          <td>{{ParamsString}}</td>
          <td>{{ReturnType}}</td>
          <td{{#SyncClass}} class="{{SyncClass}}"{{/SyncClass}}>{{SyncMode}}</td>
          <td class="muted">{{Origin}}</td>
        </tr>
        {{#HasUsageOrDesc}}
        <tr class="{{UsageRowClass}}" id="{{UsageRowId}}" style="display:none;">
          <td colspan="6">
            {{#DescriptionHtml}}
            <div class="description-content member-description">{{{DescriptionHtml}}}</div>
            {{/DescriptionHtml}}
            {{#HasUsage}}
            <div class="usage-content">
              <strong>Used in:</strong>
              <div class="usage-links">
                {{#UsageLinks}}
                <a href="{{{Link}}}" target="_blank">{{PageName}}</a>
                {{/UsageLinks}}
              </div>
            </div>
            {{/HasUsage}}
          </td>
        </tr>
        {{/HasUsageOrDesc}}
        {{/Methods}}
      </tbody>
    </table>

    {{#HasProperties}}
    <h3>Properties</h3>
    <table>
      <thead>
        <tr>
          <th class="col-toggle"></th>
          <th>Name</th>
          <th>Type</th>
          <th>Access</th>
          <th>Sync Mode</th>
          <th>Origin</th>
        </tr>
      </thead>
      <tbody>
        {{#Properties}}
        <tr{{#RowClass}} class="{{RowClass}}"{{/RowClass}}>
          <td>
            {{#HasUsageOrDesc}}
            <span class="toggle-btn" onclick="toggleUsage(this, '{{UsageRowId}}')">&#9658;</span>
            {{/HasUsageOrDesc}}
          </td>
          <td>{{Name}}</td>
          <td>{{PropertyType}}</td>
          <td>{{Access}}</td>
          <td{{#SyncClass}} class="{{SyncClass}}"{{/SyncClass}}>{{SyncMode}}</td>
          <td class="muted">{{Origin}}</td>
        </tr>
        {{#HasUsageOrDesc}}
        <tr class="{{UsageRowClass}}" id="{{UsageRowId}}" style="display:none;">
          <td colspan="6">
            {{#DescriptionHtml}}
            <div class="description-content member-description">{{{DescriptionHtml}}}</div>
            {{/DescriptionHtml}}
            {{#HasUsage}}
            <div class="usage-content">
              <strong>Used in:</strong>
              <div class="usage-links">
                {{#UsageLinks}}
                <a href="{{{Link}}}" target="_blank">{{PageName}}</a>
                {{/UsageLinks}}
              </div>
            </div>
            {{/HasUsage}}
          </td>
        </tr>
        {{/HasUsageOrDesc}}
        {{/Properties}}
      </tbody>
    </table>
    {{/HasProperties}}
  </div>
  {{/Fixtures}}

  <div class="search-container">
    <div class="search-row">
      <span class="search-label">Quick filter</span>
      <input type="text" id="searchInput" onkeyup="filterFixtures()" placeholder="Search for fixtures, namespaces, methods or properties...">
      <label class="options-toggle">
        <input type="checkbox" onchange="toggleSearchOptions(this)"> Options
      </label>
    </div>
    <div class="filter-options" id="filterOptions" style="display:none; margin-top: 10px;">
      <label><input type="checkbox" id="chkFixture" checked onchange="updateSearchOption()"> Fixture Names</label>
      <label><input type="checkbox" id="chkNamespace" checked onchange="updateSearchOption()"> Namespaces</label>
      <label><input type="checkbox" id="chkMember" checked onchange="updateSearchOption()"> Methods/Properties</label>
      <label><input type="checkbox" id="chkComment" checked onchange="updateSearchOption()"> Comments</label>
      <label><input type="checkbox" id="chkUsage" checked onchange="updateSearchOption()"> Usage</label>
    </div>
  </div>
</body>
</html>