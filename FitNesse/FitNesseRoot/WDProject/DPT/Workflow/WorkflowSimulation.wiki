---
Test
---
!1 AI Workflow Simulation

!define DPT_COMMAND {cmd.exe /c set "GEMINI_CLI=1" && cd "${TEST_DATA_PATH}" && "${DPT_EXE}" LATEST}

!2 1. Try Build without session (Expect Violation)
|script|!-SlimProxy.Process-!|
|reject|run|${DPT_COMMAND} Build !-Sample.dproj-!|
|check |last exit code|1|
|check |output contains|Bevor du mit der DPT.exe arbeiten kannst, musst du eine AI-Session starten|true|
|show  |last output|

!2 2. Start AI Session
|script|!-SlimProxy.Process-!|
|ensure|run|${DPT_COMMAND} !-AiSession-! Start|
|check |last exit code|0|
|check |output contains|AI session started for PID|true|
|show  |last output|

!2 3. Modify file to trigger "changed since session start"
|script|!-SlimProxy.Process-!|
|ensure|run|cmd.exe /c ping -n 3 127.0.0.1 >nul && cd "${TEST_DATA_PATH}" && copy /y !-SampleUnit.valid.pas-! !-SampleUnit.pas-! && copy /b !-SampleUnit.pas-! +,,|
|show  |last output|

!2 4. Try Build with session but unregistered changed file (Expect Violation)
|script|!-SlimProxy.Process-!|
|reject|run|${DPT_COMMAND} Build !-Sample.dproj-!|
|check |last exit code|1|
|check |output contains|Vor dem Build muss für alle veränderten oder erstellten Delphi-Units|true|
|show  |last output|

!2 5. Register file in AI Session
|script|!-SlimProxy.Process-!|
|ensure|run|${DPT_COMMAND} !-AiSession-! !-RegisterFiles-! !-SampleUnit.pas-!|
|check |last exit code|0|
|check |output contains|Registered file in AI session: !-SampleUnit.pas-!|true|
|show  |last output|

!2 6. Check Session Status
|script|!-SlimProxy.Process-!|
|ensure|run|${DPT_COMMAND} !-AiSession-! Status|
|check |output contains|!-SampleUnit.pas-!|true|
|show  |last output|

!2 7. Try Lint (should pass now)
|script|!-SlimProxy.Process-!|
|ensure|run|${DPT_COMMAND} Lint "${WDDT_ROOT}\Projects\DPT\Lint\TaifunUnitStyle.pas" !-SampleUnit.pas-!|
|check |last exit code|0|
|check |output contains|Linting passed|true|
|show  |last output|

!2 8. Try Build (should pass workflow check and MSBuild now)
|script|!-SlimProxy.Process-!|
|ensure|run|${DPT_COMMAND} Build !-Sample.dproj-!|
|reject|output contains|DPT WORKFLOW VIOLATION|
|check |output contains|Setting up Delphi environment|true|
|show  |last output|

!2 9. Stop AI Session
|script|!-SlimProxy.Process-!|
|ensure|run|${DPT_COMMAND} !-AiSession-! Stop|
|check |last exit code|0|
|check |output contains|AI session stopped for PID|true|
|show  |last output|
